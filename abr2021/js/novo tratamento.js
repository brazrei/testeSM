texto = "2020053016 - SBAZ GAMET VALID 301200/301800 SBGL-SBAZ AMAZONICA FIR BLW FL100SECN ISFC VIS: 1000 RA N OF S03 AND E OF W047 15/16 2000M RA N OF S07 AND S OF N01 AND W OF W047 AND E OF W0551000M RA N OF S05 AND S OF S01 AND W OF W056 AND E OF W063SIGWX : ISOL N OF S03 AND E OF W047ISOL N OF S07 AND S OF N01 AND W OF W047 AND E OF W055ISOL N OF S05 AND S OF S01 AND W OF W056 AND E OF W063SIG CLD : ISOL CB 3000/ABV 10000FT AGL N OF S03 AND E OF W047ISOL TCU 2700/ABV 10000FT AGL N OF S03 AND E OF W047ISOL CB 3000/ABV 10000FT AGL N OF S07 AND S OF N01 AND W OF W047 AND E OF W055ISOL TCU 2700/ABV 10000FT AGL N OF S07 AND S OF N01 AND W OF W047 AND E OF W055ISOL CB 3000/ABV 10000FT AGL N OF S05 AND S OF S01 AND W OF W056 AND E OF W063ISOL TCU 2700/ABV 10000FT AGL N OF S05 AND S OF S01 AND W OF W056 AND E OF W06312/14 BKN 400/800FT AGL N OF S10 AND S OF S03 AND W OF W06212/14 BKN 400/800FT AGL N OF S01 AND E OF W060 AND W OF W050SIGMET APPLICABLE: 7,8SECN IIPSYS : NILWIND/T : 2000 FT 070/11KT PS285000 FT 080/13KT PS2210000 FT 110/10KT PS10CLD : BKN CU 2700/8000FT AGL N OF S09SCT AC 9000/ABV 10000FT AGL N OF S08QNH: 1015HPASEA: T29 HGT 1.6MVA: NIL="
texto = "2020053016 - SBRE GAMET VALID 301200/301800 SBGL-SBRE RECIFE FIR BLW FL100SECN ISFC VIS: 1200 RABR N OF S11 AND S OF S06 AND E OF W035 AND W OF W03320/22 4500M RA S OF S12 AND N OF S15 AND E OF W040SIGWX: ISOL TS N OF S11 AND S OF S06 AND E OF W035 AND W OF W033SIG CLD: ISOL CB 2700/ABV 10000FT AGL N OF S11 AND S OF S06 AND E OF W035 AND W OF W033ISOL TCU 2700/ABV 10000FT AGL N OF S11 AND S OF S06 AND E OF W035 AND W OF W033ISOL TCU 2700/ABV 10000FT AGL S OF S12 AND N OF S15 AND E OF W04012/15 BKN 700/900FT AGL S OF S06 AND N OF S10 AND E OF W037SIGMET APPLICABLE: 3SECN IIPSYS: NILWIND/T: 2000FT 100/14KT PS255000FT 090/09KT PS1910000FT 070/16KT PS10CLD: SCT AC 9000/ABV 10000FT AGLBKN CU 2300/5000FT AGL E OF W041QNH: 1015HPASEA: T29 HGT 1.6MVA: NIL="
texto = "2020053101 - SBAZ GAMET VALID 310000/310600 SBGL-SBAZ AMAZONICA FIR BLW FL100SECN ISIGWX: ISOL TSMT OBSC: DIVISORSIG CLD: ISOL EMBD TCU/CB 3000/ABV 10000FT AGL/AMSLSECN IIPSYS: NILWIND/T: 2000FT 070/12KT PS23 5000FT 070/20KT PS18 10000FT 090/16KT PS09CLD: SCT CU 2300/7000FT AGL/AMSLFZLVL: ABV 10000FT AGLMNM QNH: 1012 HPASEA: T29 HGT 1,8MVA: NIL="
texto  = "2020053101 - SBBS GAMET VALID 310000/310600 SBGL-SBBS BRASILIA FIR BLW FL100SECN IHAZARDOUS WX NILSECN IIPSYS: NILWIND/T: 2000FT 100/15KT PS23 5000FT 070/13KT PS17 10000FT 350/08KT PS10CLD: BKN SC 1500/5000FT AGL N OF S12FZLVL: ABV 10000FT AGLMNM QNH: 1013 HPAVA: NIL="
texto = "2020053101 - SBRE GAMET VALID 310000/310600 SBGL-SBRE RECIFE FIR BLW FL100SECN ISFC VIS: 03/06 3000M RA N OF S13SIGWX: ISOL TS N OF S13SIG CLD: ISOL CB 3000/ABV 10000FT AGL/AMSL N OF S13ISOL TCU 2500/ABV 10000FT AGL/AMSL N OF S13BKN 900/1400FT AGL/AMSL N OF S13SECN IIPSYS: NILWIND/T: 2000FT 160/16KT PS23 5000FT 140/16KT PS17 10000FT 090/12KT PS10CLD: SCT CUSC 1500/5000FT AGL/AMSLFZLVL: ABV 10000FT AGL/ AMSLMNM QNH: 1012HPASEA: T29 HGT 1,4MVA: NIL="
texto = "2020053101 - SBCW GAMET VALID 310000/310600 SBGL -SBCW CURITIBA FIR BLW FL100SECN ISFC VIS: 02/06 3000M RA S OF S28 AND W052SIGWX: NILSIG CLD: 02/06 BKN 900/1400FT AGL S OF S28 AND W052SECN IIPSYS: NILWIND/T: 2000FT 190/18KT PS19 5000FT 280/12KT PS15 10000FT 290/34KT PS07CLD: BKN CU 2000/6500FT AGL S OF S28 AND W052AGL FZLVL: ABV 10000FT AGL/AMSLMNM QNH: 1016HPAVA: NIL="
texto = "2020053115 - SBAZ GAMET VALID 311200/311800 SBGL-SBAZ AMAZONICA FIR BLW FL100SECN ISFC VIS: 2000M RA N OF S06SIGWX:ISOL TS N OF S13SIG CLD:12/15 BKN 800/1500FT AGL N OF S13ISOL EMBD CB 3000/ABV 10000FT AGL N OF S13ISOL EMBD TCU 2000/ABV 10000FT AGL/AMSL N OF S13SECN IIPSYS: NILWIND/T:2000FT: 100/10KT PS22 5000FT: 090/14KT PS17 10000FT: 090/17KT PS09CLD:BKN AS 9000/ABV 10000FT AGL/AMSL N OF S10FZLVL: ABV 10000FT AGL/ AMSLMNM QNH:1011HPASEA:T29 HGT 1,4MVA:NIL= "
texto = "2020053115 - SBBS GAMET VALID 311200/311800 SBGL-SBBS BRASILIA FIR BLW FL100SECN IHARZARDOUS WX NILSECN IIPSYS: H 1022HPA MOV E 04KT NC S1908 W04536WIND/T:030/16KT PS24 5000FT 350/10KT PS18 10000FT 070/07KT PS10CLD:SCT CU 2000/7000FT AGLFZLVL: ABV 10000FT AGLMNM QNH: 1014HPAVA: NIL="
texto = "2020053115 - SBRE GAMET VALID 311200/311800 SBGL-SBRE RECIFE FIR BLW FL100SECN ISFC VIS:12/15 2000M RA N OF S11SIGWX:ISOL TS N OF S11SIG CLD:I12/15 BKN 800/1500FT AGL N OF S11ISOL EMBD CB 3000/ABV 10000FT AGL N OF S11ISOL EMBD TCU 2500/ABV 10000FT AGL/AMSL N OF S11SECN IIPSYS: NILWIND/T:2000FT 160/15KT PS22 5000FT 140/12KT PS15 10000FT 080/11KT PS10CLD:BKN CU 1800/5000FT AGL/AMSL BKN AS 6000/ ABV 10000FT AGL/AMSLFZLVL: ABV 10000FT AGL/ AMSLMNM QNH: 1013HPASEA:T29 HGT 1,4MVA: NIL="
texto = "2020053115 - SBCW GAMET VALID 311200/311800 SBGL -SBCW CURITIBA FIR BLW FL100SECN ISFC VIS: 3000M RA S OF S25 AND W049SIGWX: NILSIG CLD: BKN 900/1400FT AGL S OF S25 AND W049SECN IIPSYS: FRONT MOV E 15KT INTSF S2840 W05230 TO S2840 W04950WIND/T:2000FT: 160/13KT PS19 5000FT: 270/36KT PS16 10000FT: 260/45KT PS09CLD: BKN CU 1800/5000FT AGL S OF S28 AND W050 BKN AS 6000/ ABV 10000FT AGL S OF S28 AND W050FZLVL: ABV 10000FT AGLMNM QNH:1012HPAVA:NIL="
regNuvem = {nome: "",validade: "",base:"",topo:"", area:""}
arrNuvens = [regNuvem]
arrNuvensNames  = ["BKN","OVC", "ISOLCB/TCU", "ISOLTCU/CB", "ISOLTCU", "ISOLCB","EMBDTCU/CB","EMBDCB/TCU","EMBDCB","EMBDTCU","OCNLTCU/CB","OCNLCB/TCU","OCNLCB","OCNLTCU","OBSCTCU/CB","OBSCCB/TCU","OBSCCB","OBSCTCU","FRQTCU/CB","FRQCB/TCU","FRQCB","FRQTCU"]
                                     
arrNuvensNamesOk = ["BKN","OVC", "ISOL CB/TCU", "ISOL TCU/CB", "ISOL TCU", "ISOL CB","EMBD TCU/CB","EMBD CB/TCU","EMBD CB","EMBD TCU","OCNL TCU/CB","OCNL CB/TCU","OCNL CB","OCNL TCU","OBSC TCU/CB","OBSC CB/TCU","OBSC CB","OBSC TCU","FRQ TCU/CB","FRQ CB/TCU","FRQ CB","FRQ TCU"]

regVis =  {validade:"", valor: "", area: "", areaStr:""}
arrVis = [regVis]

globalValidadeTeto = ""

function removeEspacosDuplos(texto) {

   while (texto.includes("  "))
     texto = texto.replace(/  /g, " ");
   return texto
}

function getVisGamet(texto) {
  texto = removeEspacosDuplos(texto);
  texto = texto.replace(/ :/g, ":");
  arrVis.length = 0;
  texto = extractSigVis(texto)
  console.log("---)"+texto)
  if (texto.includes("SFC VIS: NIL"))
    return texto
  
  vis = texto.split("SFC VIS:")[1].split(":")[0];
  //console.log(vis)
  // falta buscar pelo campo de validade opicional
  // nuvPatt =  /\d{2}\/\d{2}[A-Z]/g; //PEGA O intervalo de validade de str sem espaços
  console.log("vis0 ==> " + vis)
  visEspaco= vis+""
  vis = vis.replace(/ /g, "");
  console.log("vis1 ==> " + vis)
  var visPatt = /(\d{4}[A-Z][A-Z][A-Z])/g;
  v = vis.match( visPatt )
  console.log("v ==> " + v)

  //separa as validades

  var valPatt =  /\d{2}\/\d{2} /g; 
  
  var arrValidVis = visEspaco.match(valPatt)
  for (var i in arrValidVis)
    visEspaco = visEspaco.replace(arrValidVis[i],"A%%"+arrValidVis[i]+"A%%")

  console.log("arrValid ==> " + arrValidVis)

  //separa em grupos de validade
  if (vis.substr(1,5).indexOf("/")<0)
     visEspaco = "A%%00/00A%%" + visEspaco
  var arrVisEspaco = visEspaco.split("A%%")
  console.log("vespaco ==> " + arrVisEspaco)
  var auxValid = ""
  var auxVis = ""
  for (var c in arrVisEspaco) {
    if (arrVisEspaco[c].substr(1,5).indexOf("/")>0)
      auxValid = arrVisEspaco[c]
    else if ((arrVisEspaco[c].length > 6) && !arrVisEspaco[c].includes("/"))
      auxVis = auxVis + arrVisEspaco[c] + "**"+ auxValid+"**"
    
  }
  vis = auxVis.replace(/ /g,"") + ""
  console.log("auxVis = >  " + auxVis)
  //strCoord = vis.split("0M")
  //console.log("strcoord =>"+strCoord)
  //for (var c in arrVisEspaco) 
  {
    //v = arrVisEspaco[c]
    //console.log("***" + v)
    //console.log("***" + vis)
    //if (arrVisEspaco[c].length>10) 
    {
    for (i=0; i < v.length; i++) {
      //console.log (v.length)
      if (v[i][4] !== "M") {
        console.log("SEM M -->"+ vis)
        //console.log("-->"+ v[i])
        var oldv = v [i].substr(0,v[i].length-1) //nunca mexer aqui sem saber o que está fazendo.
        v [i] = v[i].substr(0,4)+"M"+v[i].substr(4,2);
        vis = vis.replace(oldv, v[i])

        //console.log("oldv-->"+ oldv)
      }
      console.log("vis-->"+ vis)
      var auxVal = vis.split("**")[1]
      console.log("auxVal => "+auxVal)
      console.log("v => "+v)

      var coord = ""
      if (i < (v.length-1)) {
        coord = vis.split(v[i+1])[0]
        console.log("vis antes =>" + vis)
        vis = vis.split(v[i+1]).splice(1).join(v[i+1])
        if (!vis.includes(v[i+1]))
           vis = v[i+1] + vis
        console.log("v[i+1] =>" + v[i+1])
        console.log("vis depois =>" + vis)
        console.log (i+1)
      }
      else if (i == v.length-1) {
        coord = vis.split(v[i])[1]
        console.log("vis antes =>" + vis)
        vis = vis.split(v[i]).splice(1).join(v[i])
        console.log("1 >> "+coord)
        console.log("i >> "+i)
        console.log("v [i] >> "+v[i])
      }
      console.log("coord >> "+coord)
      console.log("vis >> "+vis)
      if (i ==0)
        coord = coord.replace(v[i],"")//exclui o grupo visibilidade

      v[i] = v[i].split("M").join("M ") //insere espaço depois do M
      coord = coord.replace(/AND/g,"") //retira os AND
    
      coord = putSpaceCoord(coord) //separa novamente as coordenadas
      console.log("3 >> "+coord)

      arrVis.push({validade:auxVal, valor: v[i], area: getLatLon(coord)})
    }
    }
  }
  //console.log(v)
  //console.log(arrVis)
 return arrVis
}
function putSpaceCoord(str) {
  return  str.replace("NOF"," N OF ").replace("SOF"," S OF ").replace("EOF"," E OF ").replace("WOF"," W OF ");

}
function getLatLon(s) {
  str =""
  if (s.includes(" IN "))
    str = " IN "
  else if (s.includes(" WI "))
    str = " WI "

  valVis = s.split(str) [0]
  if (s.includes(" E OF "))
    lon1 = (s.split(" E OF ")[1]).substr(1,3) * -1
  else
    lon1 = -999

  if (s.includes(" W OF "))
    lon0 = (s.split(" W OF ")[1]).substr(1,3) * -1
  else
    lon0 = 999

  if (s.includes(" S OF ")) {
    s1 = s.split(" S OF ")[1]
    lat0 = (s1).substr(1,2)
    if (s1[0]==("S"))
      lat0 = lat0 * -1
    else
      lat0 = lat0 * 1
  }
  else
    lat0 = 999

  if (s.includes(" N OF ")) {
   s1 = s.split(" N OF ")[1]
   lat1 = (s1).substr(1,2)
   if (s1[0]==("S"))
      lat1 = lat1 * -1
   else
      lat1 = lat1 * 1
  }
  else
    lat1 = -999

 //return "lat = " + lat0+ "/"+lat1 + "--- long =" + lon0+"/"+lon1
   return {lat0: lat0, lat1: lat1, lon0: lon0, lon1: lon1}
}

function getValidades(texto) {
    t = texto.replace(/ /g, "");
    //console.log("t => " + t )

    nuvPatt2 =  /\d{2}\/\d{2}[A-Z]/g; //PEGA O intervalo de validade de str sem espaços
     

  return t.match(nuvPatt2)
}
  function getValidTxt(texto) {
    nuvPatt2 =  /\d{2}\/\d{2}/g; //PEGA O intervalo de validade de str sem espaços
    texto = texto.match(nuvPatt2)
    if (texto)
      return texto[0]
    else
      return ""
  }

  function getValid(texto) {
    t = getValidades(texto)
    //console.log("t => " + t )
    if (t == null)
      return -1
    
    t = t[0]+""
    t = t.substr(0,5) 
    return t
  }

  function getIndexValid(texto) {
    t = getValid(texto)
    //console.log("t => " + t )
    return texto.indexOf(t)
  }

  function getNuvemName(texto) {
     //BKN ou OVC [n]nnn/[n]nnnM (FT) AGL ou AMSL 
     //ISOL ou OCNL ou FRQ ou OBSC ou EMBD CB2ou TCU2[n]nnn/[n]nnnM (FT) AGL ou AMSL
     var texto = texto.replace(/ /g, "");
     var camada = texto.split("FT")[0]
     //console.log("camada = "+camada)
     //console.log(arrNuvensNames)
     for (var i=0;i < arrNuvensNames.length; i++) {
        idx = camada.indexOf(arrNuvensNames[i]) 
       //console.log(idx + " ==> " + arrNuvensNames[i])
       if (idx > -1) {
          return arrNuvensNamesOk[i]
       }
     }
     return ""
  }

function extractSigCld(texto) {
    if (!texto.includes("SIG CLD:"))
      return "SIG CLD: NIL"
    nuvens = texto.split("SIG CLD:")[1].split(":")[0];
    nuvens = nuvens.split("SECN")[0];
    nuvens = nuvens.split("SIGMET")[0];
    nuvens = nuvens.split("MTW:")[0];
    nuvens = nuvens.split("TURB:")[0];
    nuvens = nuvens.split("ICE:")[0];
    
  return nuvens
}
function extractSigVis(texto) {
    //console.log(texto)
    if (!texto.includes("SFC VIS:"))
      return "SFC VIS: NIL"
    
    var vis = texto.split("SFC VIS:")[1].split(":")[0];
    //console.log(vis)

    vis = vis.split("SECN")[0];
    vis = vis.split("SIGMET")[0];
    vis = vis.split("MTW")[0];
    vis = vis.split("TURB")[0];
    vis = vis.split("ICE")[0];
    vis = vis.split("MT OBSC")[0];
    vis = vis.split("SIGWX")[0];
    
    
    //console.log(vis)
    
  return "SFC VIS: "+vis
}

  function getTetoGamet(nuvem) {
   //arrNuvens.length = 0
    var base = 0
    var topo = 0
    var nome = ""
    nuvemName = getNuvemName(nuvem);
    nuvens = nuvem
    nuvPattTopo =  /\d{4}FT/g; //PEGA O TOPO
    nuvPattBase = /\d{4}\//g; // pega a base
    
    var camada = nuvens.split("0FT")[0]+"0FT"
    //console.log(camada)

    var base = camada.match( nuvPattBase);
    if (base)
      base = base[0]

    var topo = camada.match( nuvPattTopo);

    if (topo)
      topo = topo[0]	
    
    if (base == null) { //base com apenas 3 dígitos
     nuvPattBase = /\d{3}\//g; // pega a base
     base = camada.match( nuvPattBase)[0];
    }

    if (topo == null) { //topo com apenas 3 dígitos
      nuvPattTopo =  /\d{3}FT/g; //PEGA O TOPO
      topo = camada.match( nuvPattTopo)[0];	
    }

    base = base.replace(/\D/g,'');
    if (topo == "0000FT")
      topo = "ABV 10000FT"
    else 
      topo = topo.replace(/\D/g,'');
    validade=""

    var area = getLatLon(nuvem)
    arrNuvens.push({nome:nuvemName, validade: globalValidadeTeto, base: base,topo: topo, area: area})
    //console.log("Nome da Nuvem = "+ nuvemName)
    //console.log("validade = " + validade)
    //console.log("nuvens = " + nuvens)
    //console.log(arrNuvens)

    $("#msg").html("Nuvens = >" + arrNuvens[0].nome)

  /* 
     //console.log(idxValid)


    nuvens = nuvens.replace(/ /g, "");
    nuvPatt1 =  /\d{4}FT/g; //PEGA O TOPO
    nuvPatt2 =  /\d{2}\/\d{2}[A-Z]/g; //PEGA O intervalo de validade de str sem espaços
    nuvPatt3 = /\d{3}\//g; // pega a base
    base = nuvens.match( nuvPatt3 );
    valid = nuvens.match( nuvPatt2 );
    topo = nuvens.match( nuvPatt1 );	
    
    str = "</br>SIG CLD: "
    for (var i = 0; i < base.length; i++) {
      b = base[i].split("/")[0]
      t = topo[i]
      if (t[0]=="/")
        
      if (t == "000FT")
        t = "ABV 10000FT"
      if (b > 0)
        str = str + "| " +b+"/" + t + " |" 
    }*/
    return str;
  }
  
function getNuvensGamet(texto) {
    arrNuvens.length = 0
    var texto = texto.replace(/	/g," ") // troca tabs por espaços
    texto = removeEspacosDuplos(texto)
    texto = texto.replace(/\/ /g, "/"); //remove espaços proximos as barras
    texto = texto.replace(/ \//g, "/");
    texto = texto.replace(/ :/g, ":");

  
    texto = extractSigCld(texto)

    arrSigCld = texto.split(/(?=FT)/g)
    //console.log(arrSigCld)

  
    //console.log("Antes do %% =>"+texto )
    for (var i in arrNuvensNamesOk) {
      //while (texto.includes()) 
      var str = arrNuvensNamesOk[i]
      //const regex = new RegExp(`ReGeX${str}ReGeX`);

      texto = texto.split(str).join("B%%"+str)
    }
  
    //console.log("Depois do %% =>"+texto )
    camadas = texto.split("B%%")

    //console.log(camadas)
    //console.log(texto)

    //quebra as validades
    arrValids = getValidades(texto)
//    if (!arrValids)
//      arrValids = ["00/00"]
    for (var i in arrValids) {
      var str = arrValids[i].slice(0, -1); 
      texto = texto.split(str).join("A%%"+str)
    }

    //console.log(arrValids)
    //console.log(camadas)
    //console.log(texto)

    //if (texto[0] == " ")
    //texto = texto.slice(1)
    camadas = texto.split("A%%")

    //console.log("texto 0 " + texto[0])
    //console.log("quebrou A%%")
    if (camadas[0].length > 10)
      camadas[0] = "00/00 "+camadas [0]
    console.log(camadas)

    for (var i in camadas) {
      camadas[i] = camadas[i].split("B%%")
    }
    console.log(camadas)
    //for (var i = 0; i < )
    for (var i in camadas) {
      if (camadas) {
        if (camadas[i].constructor === Array){
          for (var j in camadas[i]){
            console.log((camadas[i][j]).length)
            if ((camadas[i][j]).includes("FT")){
              //console.log(i + " - "+ j +" - "+ camadas[i][j])
            
              getTetoGamet(camadas[i][j])
            } else {
              var v = getValidTxt(camadas[i][j]+"")
              if (v.indexOf("/")>0)
                globalValidadeTeto = v
              //console.log(i + " - "+ j +" - "+v)
            }
          }
        }  
      }
    }
    //console.log("sem erros até aqui 1")
    //console.log(texto)
  
    return arrNuvens
}
//console.log(texto)
console.log("Resultado da Visibilidade:")
console.log(getVisGamet(texto))   
console.log("Resultado das nuvens:")
console.log(getNuvensGamet(texto))

